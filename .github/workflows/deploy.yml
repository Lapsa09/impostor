name: Deploy to Railway

# Deploy manual recomendado: railway up
# Railway CLI token authentication es compleja para CI/CD
on:
  workflow_dispatch: # Solo manual desde GitHub UI
  # push:
  #   branches: [main]  # Desactivado - usar 'railway up' localmente
jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸ“¦ Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: ğŸŸ¢ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "pnpm"

            - name: ğŸ“¥ Install dependencies
              run: pnpm install --frozen-lockfile

            - name: ğŸ—ï¸ Build application
              run: pnpm run build:ci
              env:
                  ADMIN_KEY: ${{ secrets.ADMIN_KEY }}

            - name: ğŸš‚ Install Railway CLI
              run: npm install -g @railway/cli

            - name: ğŸ”— Link Railway Project
              run: railway link --project 9a066a2c-c545-41d7-8a87-7dfa48538cce --environment production
              env:
                  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

            - name: ğŸš€ Deploy to Railway
              run: railway up --service 2e79b7e2-c5bf-4070-a1dc-da90082c491b
              env:
                  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

            - name: âœ… Deployment completed
              run: echo "ğŸ‰ Deployed successfully to Railway!"
